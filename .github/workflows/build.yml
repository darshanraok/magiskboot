name: Build magiskboot (Latest Magisk C++)

on:
  workflow_dispatch:      # Run manually
  schedule:
    - cron: "0 */6 * * *" # Check every 6 hours

jobs:

  check-magisk:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      latest_commit: ${{ steps.check.outputs.latest_commit }}

    steps:
      - name: Fetch latest Magisk commit
        id: check
        run: |
          LATEST=$(git ls-remote https://github.com/topjohnwu/Magisk HEAD | awk '{print $1}')
          echo "latest_commit=$LATEST" >> $GITHUB_OUTPUT

          if [ -f last_magisk_commit.txt ]; then
            OLD=$(cat last_magisk_commit.txt)
          else
            OLD=""
          fi

          if [ "$LATEST" = "$OLD" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Save latest commit hash
        if: steps.check.outputs.should_build == 'true'
        run: echo "${{ steps.check.outputs.latest_commit }}" > last_magisk_commit.txt

      - uses: actions/upload-artifact@v4
        if: steps.check.outputs.should_build == 'true'
        with:
          name: last_commit
          path: last_magisk_commit.txt


  build:
    needs: check-magisk
    if: needs.check-magisk.outputs.should_build == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download last commit artifact
        uses: actions/download-artifact@v4
        with:
          name: last_commit
          path: .

      - name: Install build tools
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y clang lld llvm gcc g++ cmake python3 unzip wget curl gh gcc-multilib g++-multilib libc6-dev-i386

      - name: Verify sha256sum
        run: sha256sum --version

      - name: Install Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip
          mv android-ndk-r26d $HOME/ndk
          export ANDROID_NDK_HOME=$HOME/ndk

      - name: Clone Magisk
        run: git clone https://github.com/topjohnwu/Magisk --depth=1 magisk

      - name: Build magiskboot
        run: |
          export ANDROID_NDK_HOME=$HOME/ndk
          export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

          mkdir -p out

          # Android builds using CMake + NDK
          for arch in arm arm64 x86 x86_64; do
            case $arch in
              arm) ABI="armeabi-v7a";;
              arm64) ABI="arm64-v8a";;
              x86) ABI="x86";;
              x86_64) ABI="x86_64";;
            esac

            BUILD_DIR="magisk/native/build-$arch"
            mkdir -p $BUILD_DIR
            cd $BUILD_DIR

            cmake -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
                  -DANDROID_ABI=$ABI -DANDROID_PLATFORM=android-21 ../src/boot

            cmake --build . --target magiskboot

            cp magiskboot ../../../out/magiskboot-$arch
            cd ../../..
          done

          # Linux builds
          cd magisk/native/src/boot

          # Linux 64-bit
          g++ -O2 -o ../../../out/magiskboot-linux *.cpp

          # Linux 32-bit
          g++ -m32 -O2 -o ../../../out/magiskboot-linux32 *.cpp
          cd ../../../

      - name: Generate SHA256 checksums
        run: |
          cd out
          sha256sum magiskboot-* > magiskboot-checksums.txt
          cat magiskboot-checksums.txt

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "magiskboot-${{ needs.check-magisk.outputs.latest_commit }}"
          files: out/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old releases (keep latest 5)
        run: |
          TAGS=$(gh release list --limit 100 | awk '{print $1}')
          COUNT=0
          for tag in $TAGS; do
            COUNT=$((COUNT+1))
            if [ $COUNT -le 5 ]; then continue; fi
            echo "Deleting old release $tag"
            gh release delete "$tag" -y
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
