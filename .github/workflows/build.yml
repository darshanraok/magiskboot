name: Build magiskboot (All Platforms)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Magisk repo
        uses: actions/checkout@v4
        with:
          repository: topjohnwu/Magisk
          path: magisk
          fetch-depth: 1

      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y clang lld llvm gcc g++ python3 unzip wget curl \
                             gcc-multilib g++-multilib libc6-dev-i386 \
                             mingw-w64 make cmake

      - name: Install Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip -d $RUNNER_TEMP
          mv $RUNNER_TEMP/android-ndk-r26d $HOME/ndk
          echo "Android NDK installed at $HOME/ndk"

      - name: Create output directory
        run: mkdir -p out

      - name: Build Android binaries
        run: |
          export ANDROID_NDK_HOME=$HOME/ndk
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH

          # Correct include paths
          INCLUDE_FLAGS="-I magisk/native/include \
                         -I magisk/native/src/boot \
                         -I magisk/common/include \
                         -I magisk/common \
                         -I magisk/common/libcutils \
                         -I magisk/common/selinux"

          SRC_FILES="magisk/native/src/boot/*.cpp"

          # Android ARM
          armv7a-linux-androideabi21-clang++ -O2 $INCLUDE_FLAGS -o out/magiskboot-arm $SRC_FILES
          aarch64-linux-android21-clang++ -O2 $INCLUDE_FLAGS -o out/magiskboot-arm64 $SRC_FILES
          i686-linux-android21-clang++ -O2 $INCLUDE_FLAGS -o out/magiskboot-x86 $SRC_FILES
          x86_64-linux-android21-clang++ -O2 $INCLUDE_FLAGS -o out/magiskboot-x86_64 $SRC_FILES

      - name: Build Linux binaries
        run: |
          INCLUDE_FLAGS="-I magisk/native/include \
                         -I magisk/native/src/boot \
                         -I magisk/common/include \
                         -I magisk/common \
                         -I magisk/common/libcutils \
                         -I magisk/common/selinux"

          SRC_FILES="magisk/native/src/boot/*.cpp"

          g++ -O2 $INCLUDE_FLAGS -o out/magiskboot-linux $SRC_FILES
          g++ -m32 -O2 $INCLUDE_FLAGS -o out/magiskboot-linux32 $SRC_FILES

      - name: Build Windows binaries
        run: |
          INCLUDE_FLAGS="-I magisk/native/include \
                         -I magisk/native/src/boot \
                         -I magisk/common/include \
                         -I magisk/common \
                         -I magisk/common/libcutils \
                         -I magisk/common/selinux"

          SRC_FILES="magisk/native/src/boot/*.cpp"

          x86_64-w64-mingw32-g++ -O2 $INCLUDE_FLAGS -o out/magiskboot-windows64.exe $SRC_FILES
          i686-w64-mingw32-g++ -O2 $INCLUDE_FLAGS -o out/magiskboot-windows32.exe $SRC_FILES

      - name: Generate SHA256 checksums
        run: |
          cd out
          sha256sum * > magiskboot-checksums.txt
          cat magiskboot-checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: magiskboot-${{ github.run_id }}
          files: out/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
