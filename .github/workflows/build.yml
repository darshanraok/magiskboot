name: Build MagiskBoot

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_NDK: /opt/android-ndk

    steps:
      # 1️⃣ Checkout the full Magisk repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # fetch full history so submodules (if any) can work

      # 2️⃣ Install Rust
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # 3️⃣ Download Android NDK
      - name: Setup Android NDK
        uses: android-actions/setup-ndk@v2
        with:
          ndk-version: '25.2.9519653'
          path: ${{ env.ANDROID_NDK }}

      # 4️⃣ Add Rust Android targets
      - name: Add Rust targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi

      # 5️⃣ Configure Cargo linker to use NDK
      - name: Configure Cargo linker
        run: |
          mkdir -p native/src/boot/.cargo
          cat <<EOF > native/src/boot/.cargo/config.toml
          [target.aarch64-linux-android]
          ar = "aarch64-linux-android-ar"
          linker = "aarch64-linux-android21-clang"

          [target.armv7-linux-androideabi]
          ar = "arm-linux-androideabi-ar"
          linker = "armv7a-linux-androideabi21-clang"
          EOF

      # 6️⃣ Build ARM64 Android
      - name: Build ARM64 Android
        working-directory: native/src/boot
        run: cargo build --release --target aarch64-linux-android

      # 7️⃣ Build ARM32 Android
      - name: Build ARM32 Android
        working-directory: native/src/boot
        run: cargo build --release --target armv7-linux-androideabi

      # 8️⃣ Optional: Build Linux x86_64
      - name: Build Linux x86_64
        working-directory: native/src/boot
        run: cargo build --release

      # 9️⃣ Create GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          draft: false
          prerelease: false

      # 10️⃣ Upload ARM64 binary
      - name: Upload ARM64 binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: native/src/boot/target/aarch64-linux-android/release/magiskboot
          asset_name: magiskboot-arm64
          asset_content_type: application/octet-stream

      # 11️⃣ Upload ARM32 binary
      - name: Upload ARM32 binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: native/src/boot/target/armv7-linux-androideabi/release/magiskboot
          asset_name: magiskboot-armv7
          asset_content_type: application/octet-stream

      # 12️⃣ Upload Linux x86_64 binary
      - name: Upload Linux x86_64 binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: native/src/boot/target/release/magiskboot
          asset_name: magiskboot-linux-x86_64
          asset_content_type: application/octet-stream
