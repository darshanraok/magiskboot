name: Build MagiskBoot from upstream

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_NDK_DIR: ${{ github.workspace }}/android-ndk

    steps:
      # 1Ô∏è‚É£ Checkout this repo (for release upload)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Clone the full Magisk repository
      - name: Clone Magisk repository
        run: |
          git clone https://github.com/topjohnwu/Magisk.git magisk-src
          cd magisk-src
          git checkout v29.0
          git submodule update --init --recursive

      - name: Install Rust nightly
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true

      - name: Add Rust source for cross-compilation
        run: rustup component add rust-src --toolchain nightly

  # 4Ô∏è‚É£ Download and setup Android NDK
      - name: Download Android NDK
        run: |
          curl -L https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -o ndk.zip
          unzip ndk.zip
          mv android-ndk-r25c $ANDROID_NDK_DIR
          echo "ANDROID_NDK=$ANDROID_NDK_DIR" >> $GITHUB_ENV
          echo "$ANDROID_NDK_DIR/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      # 5Ô∏è‚É£ Add Rust Android targets
      - name: Add Rust targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi

      # 6Ô∏è‚É£ Configure Cargo linker for NDK
      - name: Configure Cargo linker
        run: |
          mkdir -p magisk-src/native/src/boot/.cargo
          cat <<EOF > magisk-src/native/src/boot/.cargo/config.toml
          [target.aarch64-linux-android]
          ar = "aarch64-linux-android-ar"
          linker = "aarch64-linux-android21-clang"

          [target.armv7-linux-androideabi]
          ar = "arm-linux-androideabi-ar"
          linker = "armv7a-linux-androideabi21-clang"
          EOF

      # 7Ô∏è‚É£ Build ARM64 Android
      - name: Build ARM64
        working-directory: magisk-src/native/src/boot
        run: cargo build --release --target aarch64-linux-android

      # 8Ô∏è‚É£ Build ARM32 Android
      - name: Build ARM32
        working-directory: magisk-src/native/src/boot
        run: cargo build --release --target armv7-linux-androideabi

      # 9Ô∏è‚É£ Optional: Build Linux x86_64
      - name: Build Linux
        working-directory: magisk-src/native/src/boot
        run: cargo build  --release

      # üîü Create GitHub Release
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          draft: false
          prerelease: false

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload ARM64 binary
      - name: Upload ARM64
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: magisk-src/native/src/target/aarch64-linux-android/release/magiskboot
          asset_name: magiskboot-arm64
          asset_content_type: application/octet-stream

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload ARM32 binary
      - name: Upload ARM32
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: magisk-src/native/src/target/armv7-linux-androideabi/release/magiskboot
          asset_name: magiskboot-armv7
          asset_content_type: application/octet-stream

      # 1Ô∏è‚É£3Ô∏è‚É£ Upload Linux binary
      - name: Upload Linux
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: magisk-src/native/src/target/release/magiskboot
          asset_name: magiskboot-linux-x86_64
          asset_content_type: application/octet-stream
