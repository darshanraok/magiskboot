name: Build magiskboot (All Platforms)

on:
  workflow_dispatch:      # Manual trigger
  schedule:
    - cron: "0 */6 * * *" # Run every 6 hours

jobs:
  check-magisk:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      latest_commit: ${{ steps.check.outputs.latest_commit }}

    steps:
      - name: Fetch latest Magisk commit
        id: check
        run: |
          LATEST=$(git ls-remote https://github.com/topjohnwu/Magisk HEAD | awk '{print $1}')
          echo "latest_commit=$LATEST" >> $GITHUB_OUTPUT

          if [ -f last_magisk_commit.txt ]; then
            OLD=$(cat last_magisk_commit.txt)
          else
            OLD=""
          fi

          if [ "$LATEST" = "$OLD" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Save latest commit hash
        if: steps.check.outputs.should_build == 'true'
        run: echo "${{ steps.check.outputs.latest_commit }}" > last_magisk_commit.txt

      - uses: actions/upload-artifact@v4
        if: steps.check.outputs.should_build == 'true'
        with:
          name: last_commit
          path: last_magisk_commit.txt

  build:
    needs: check-magisk
    if: needs.check-magisk.outputs.should_build == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download last commit artifact
        uses: actions/download-artifact@v4
        with:
          name: last_commit
          path: .

      - name: Install build tools
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y clang lld llvm gcc g++ python3 unzip wget curl gh \
                             gcc-multilib g++-multilib libc6-dev-i386 \
                             mingw-w64

      - name: Verify sha256sum
        run: sha256sum --version

      - name: Install Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip
          mv android-ndk-r26d $HOME/ndk
          export ANDROID_NDK_HOME=$HOME/ndk

      - name: Clone Magisk
        run: git clone https://github.com/topjohnwu/Magisk --depth=1 magisk

      - name: Build magiskboot
        run: |
          export ANDROID_NDK_HOME=$HOME/ndk
          export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

          mkdir -p out

          INCLUDE_FLAGS="-I magisk/native/include -I magisk/native/src/boot"

          # --- Android ---
          declare -A ANDROID_ABIS=( ["arm"]="armv7a-linux-androideabi21-clang++"
                                     ["arm64"]="aarch64-linux-android21-clang++"
                                     ["x86"]="i686-linux-android21-clang++"
                                     ["x86_64"]="x86_64-linux-android21-clang++" )

          for arch in "${!ANDROID_ABIS[@]}"; do
            COMPILER=${ANDROID_ABIS[$arch]}
            echo "Building Android $arch"
            $COMPILER -O2 $INCLUDE_FLAGS \
                      -o out/magiskboot-$arch magisk/native/src/boot/*.cpp
          done

          # --- Linux ---
          cd magisk/native/src/boot
          g++ -O2 $INCLUDE_FLAGS -o ../../../out/magiskboot-linux *.cpp
          g++ -m32 -O2 $INCLUDE_FLAGS -o ../../../out/magiskboot-linux32 *.cpp
          cd ../../../

          # --- Windows ---
          cd magisk/native/src/boot
          x86_64-w64-mingw32-g++ -O2 $INCLUDE_FLAGS -o ../../../out/magiskboot-windows64.exe *.cpp
          i686-w64-mingw32-g++ -O2 $INCLUDE_FLAGS -o ../../../out/magiskboot-windows32.exe *.cpp
          cd ../../../

      - name: Generate SHA256 checksums
        run: |
          cd out
          sha256sum * > magiskboot-checksums.txt
          cat magiskboot-checksums.txt

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "magiskboot-${{ needs.check-magisk.outputs.latest_commit }}"
          files: out/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old releases (keep latest 5)
        run: |
          TAGS=$(gh release list --limit 100 | awk '{print $1}')
          COUNT=0
          for tag in $TAGS; do
            COUNT=$((COUNT+1))
            if [ $COUNT -le 5 ]; then continue; fi
            echo "Deleting old release $tag"
            gh release delete "$tag" -y
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
