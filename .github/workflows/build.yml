name: Build magiskboot

on:
  push:
    tags:
      - 'v*'        # Trigger on version tags
  workflow_dispatch:

jobs:
  build:
    name: Build magiskboot
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: r25b  # Update if needed

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v3

    - name: Install Rust nightly
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly-2025-05-01   # Pin nightly version
        override: true

    - name: Add rust-src component
      run: rustup component add rust-src --toolchain nightly-2025-05-01

    - name: Download Android NDK
      run: |
        export ANDROID_NDK_HOME=$RUNNER_TEMP/android-ndk
        curl -L https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip -o ndk.zip
        unzip ndk.zip -d $RUNNER_TEMP
        mv $RUNNER_TEMP/android-ndk-${ANDROID_NDK_VERSION} $ANDROID_NDK_HOME
        echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

    - name: Add Android targets for Rust
      run: |
        rustup target add aarch64-linux-android
        rustup target add armv7-linux-androideabi

    - name: Clone Magisk repo
      run: |
        git clone https://github.com/topjohnwu/Magisk.git magisk-src
        cd magisk-src
        git checkout v29.0
        git submodule update --init --recursive
        ls -R magisk-src/native/src/boot

    - name: Patch Cargo.toml for CLI binary
      working-directory: magisk-src/native/src/boot
      run: |
        echo "" >> Cargo.toml
        echo "[[bin]]" >> Cargo.toml
        echo 'name = "magiskboot"' >> Cargo.toml
        echo 'path = "cli.rs"' >> Cargo.toml

    
    
    
    
    
    
    
    
    - name: Build magiskboot for ARM64
      run: |
        cd magisk-src/native/src
        cargo build --release --package magiskboot --target aarch64-linux-android
        echo "Listing release folder:"
        ls -l ../../target/aarch64-linux-android/release
        BIN=$(find ../../target/aarch64-linux-android/release -maxdepth 1 -type f -executable | head -n 1)
        echo "ARM64 binary: $BIN"
        cp "$BIN" ../../target/aarch64-linux-android/release/magiskboot

    - name: Build magiskboot for ARM32
      run: |
        cd magisk-src/native/src
        cargo build --release --package magiskboot --target armv7-linux-androideabi
        echo "Listing release folder:"
        ls -l ../../target/armv7-linux-androideabi/release
        BIN=$(find ../../target/armv7-linux-androideabi/release -maxdepth 1 -type f -executable | head -n 1)
        echo "ARM32 binary: $BIN"
        cp "$BIN" ../../target/armv7-linux-androideabi/release/magiskboot

    - name: Upload binaries to release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          magisk-src/native/target/aarch64-linux-android/release/magiskboot
          magisk-src/native/target/armv7-linux-androideabi/release/magiskboot
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
