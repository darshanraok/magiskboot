name: Build magiskboot

on:
  push:
    tags:
      - 'v*'        # Trigger on version tags
  workflow_dispatch:

jobs:
  build:
    name: Build magiskboot
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 25.2.9519653  # Update if needed
      ANDROID_NDK_HOME: ${{ runner.temp }}/android-ndk

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v3

    - name: Install Rust nightly
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly-2025-05-01   # Pin the Rust nightly used for Magisk v29.0
        override: true

    - name: Add rust-src component
      run: rustup component add rust-src --toolchain nightly-2025-05-01

    - name: Download Android NDK
      run: |
        curl -L https://dl.google.com/android/repository/android-ndk-r${ANDROID_NDK_VERSION}-linux.zip -o ndk.zip
        unzip ndk.zip -d ${{ runner.temp }}
        mv ${{ runner.temp }}/android-ndk-r${ANDROID_NDK_VERSION} $ANDROID_NDK_HOME

    - name: Add NDK toolchains to PATH
      run: |
        echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Add Android targets for Rust
      run: |
        rustup target add aarch64-linux-android
        rustup target add armv7-linux-androideabi

    - name: Clone Magisk repo
      run: |
        git clone https://github.com/topjohnwu/Magisk.git magisk-src
        cd magisk-src
        git checkout v29.0
        git submodule update --init --recursive

    - name: Build magiskboot for ARM64
      run: |
        cd magisk-src/native/src/boot
        cargo build --release --target aarch64-linux-android

    - name: Build magiskboot for ARM32
      run: |
        cd magisk-src/native/src/boot
        cargo build --release --target armv7-linux-androideabi

    - name: Upload binaries to release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          magisk-src/native/target/aarch64-linux-android/release/boot
          magisk-src/native/target/armv7-linux-androideabi/release/boot
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
