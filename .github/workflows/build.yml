name: Build magiskboot (All Platforms)

on:
  workflow_dispatch:      # Manual trigger
  schedule:
    - cron: "0 */6 * * *" # Run every 6 hours

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Magisk repo
        uses: actions/checkout@v4
        with:
          repository: topjohnwu/Magisk
          path: magisk
          fetch-depth: 1

      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y clang lld llvm gcc g++ python3 unzip wget curl \
                             gcc-multilib g++-multilib libc6-dev-i386 \
                             mingw-w64 make cmake

      - name: Install Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip android-ndk-r26d-linux.zip
          mv android-ndk-r26d $HOME/ndk
          export ANDROID_NDK_HOME=$HOME/ndk
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH

      - name: Build magiskboot Android arm
        run: |
          cd magisk/native
          ./magiskboot.sh arm
          mv magiskboot ../../out/magiskboot-arm

      - name: Build magiskboot Android arm64
        run: |
          cd magisk/native
          ./magiskboot.sh arm64
          mv magiskboot ../../out/magiskboot-arm64

      - name: Build magiskboot Android x86
        run: |
          cd magisk/native
          ./magiskboot.sh x86
          mv magiskboot ../../out/magiskboot-x86

      - name: Build magiskboot Android x86_64
        run: |
          cd magisk/native
          ./magiskboot.sh x86_64
          mv magiskboot ../../out/magiskboot-x86_64

      - name: Build Linux binaries
        run: |
          cd magisk/native
          make magiskboot-linux
          make magiskboot-linux32
          mv magiskboot-linux ../../out/magiskboot-linux
          mv magiskboot-linux32 ../../out/magiskboot-linux32

      - name: Build Windows binaries
        run: |
          cd magisk/native
          make magiskboot-windows64
          make magiskboot-windows32
          mv magiskboot-windows64.exe ../../out/magiskboot-windows64.exe
          mv magiskboot-windows32.exe ../../out/magiskboot-windows32.exe

      - name: Generate SHA256 checksums
        run: |
          cd out
          sha256sum * > magiskboot-checksums.txt
          cat magiskboot-checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: magiskboot-${{ github.run_id }}
          files: out/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
