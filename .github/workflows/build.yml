name: Build MagiskBoot for All Android ABIs

on:
  push:
    # Trigger the workflow on pushes to the main branch
    branches: [ main ]
    paths:
      # Only run if files in the 'native' directory (where magiskboot source lives) change
      - 'native/**' 
  pull_request:
    branches: [ main ]
    paths:
      - 'native/**'
  # Allows manual triggering from the Actions tab
  workflow_dispatch:

jobs:
  build_magiskboot:
    # Use a matrix strategy to build for multiple architectures
    strategy:
      fail-fast: false
      matrix:
        # Define the target ABIs (Application Binary Interfaces)
        abi: [ arm, arm64, x86, x86_64 ]
    
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        # Set to a large depth for full history, needed for some Magisk scripts
        with:
          submodules: true 
          fetch-depth: 0

      - name: ðŸ Set up Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ðŸ¦€ Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          # Magisk uses stable Rust
          toolchain: stable
          
      - name: âš™ï¸ Install Build Dependencies
        # Essential tools for Magisk's build script
        run: |
          sudo apt-get update
          # Magisk often uses lz4, lzma, etc., and clang for NDK builds
          sudo apt-get install -y lzma liblzma-dev lz4 liblz4-dev clang automake autoconf pkg-config

      - name: ðŸ“¥ Download & Setup Android NDK
        # Magisk requires the NDK for cross-compilation
        uses: android-actions/setup-ndk@v2
        with:
          # Using a relatively recent NDK version
          ndk-version: '25.2.9519653'
          # Exporting the path for the build script
          ndk-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ› ï¸ Build MagiskBoot for ${{ matrix.abi }}
        env:
          # Set the target ABI from the matrix
          ABI: ${{ matrix.abi }}
          # Set the NDK path - important for the build script to find toolchains
          NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          # The official Magisk repository typically has a build script (like build.py) 
          # or a simple Makefile/shell script to handle native compilation.
          # We'll assume a shell script in 'native/magiskboot' for this example.
          # You may need to adjust this command based on your magiskboot source structure.
          echo "Attempting to build magiskboot for $ABI..."
          # The actual command in the original Magisk repo is usually driven by build.py.
          # If you're building a fork of Magisk, consult its build script logic.
          # Here is a generic command that often works for NDK-based C/C++ projects:
          # You might need to adjust the path to your C/C++ source code.
          python3 build.py native/magiskboot $ABI
          
          # Assuming the final binary is named 'magiskboot' and placed in a specific path
          # Adjust the path below based on where your build script places the output.
          MAGISKBOOT_PATH="out/$ABI/magiskboot"
          if [ -f "$MAGISKBOOT_PATH" ]; then
            echo "Successfully built magiskboot for $ABI"
            echo "MAGISKBOOT_PATH=$MAGISKBOOT_PATH" >> $GITHUB_ENV
          else
            echo "::error::magiskboot binary not found at $MAGISKBOOT_PATH"
            exit 1
          fi

      - name: ðŸ“¦ Upload ${{ matrix.abi }} Artifact
        uses: actions/upload-artifact@v4
        with:
          # The artifact name specifies the ABI for easy identification
          name: magiskboot-${{ matrix.abi }}
          # Use the environment variable set in the previous step
          path: ${{ env.MAGISKBOOT_PATH }}
          retention-days: 7
