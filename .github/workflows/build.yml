name: Magiskboot Universal Compiler and Release

on:
  # Manual trigger to start the build
  workflow_dispatch:
    inputs:
      magisk_branch:
        description: 'Magisk Branch, Tag, or Commit to build from'
        required: true
        default: 'master'

jobs:
  build_magiskboot:
    runs-on: ubuntu-latest
    
    env:
      MAGISK_REPO: https://github.com/topjohnwu/Magisk.git
      MAGISK_BRANCH: ${{ github.event.inputs.magisk_branch }}
      BUILD_DIR: ${{ github.workspace }}/build/bin
      
    steps:
      - name: ‚¨áÔ∏è Checkout Magisk Source
        uses: actions/checkout@v4
        with:
          repository: ${{ env.MAGISK_REPO }}
          ref: ${{ env.MAGISK_BRANCH }}
          submodules: 'recursive' # Magisk uses submodules for some dependencies

      - name: üêç Setup Python 3.10+ and Rust
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      - name: üîß Install Python Dependencies
        run: pip install colorama
        
      # --- Install Build Dependencies for Linux/Windows Targets ---
      - name: ‚öôÔ∏è Install Cross-Compilation Tools and Libraries
        run: |
          sudo apt-get update
          # Standard C/C++ compilation tools
          sudo apt-get install -y cmake build-essential
          # Multi-arch support for linux32
          sudo apt-get install -y gcc-multilib g++-multilib 
          # Mingw-w64 for Windows cross-compilation
          sudo apt-get install -y mingw-w64 
          
          # Libraries required by magiskboot (LZMA/XZ, LZ4, Bzip2, Zlib)
          sudo apt-get install -y liblzma-dev liblz4-dev libbz2-dev zlib1g-dev

          # Install Rust toolchain components (Magisk uses Rust for some components)
          rustup default stable

      - name: ‚¨áÔ∏è Download and Setup Android NDK
        # The Magisk build script requires the NDK to be present
        run: ./build.py ndk
        
      - name: üèóÔ∏è Compile magiskboot for Android Targets (arm32, arm64, x86, x64)
        # Uses the official Magisk Python script with NDK
        run: |
          echo "Compiling native binaries with ./build.py binary"
          ./build.py binary
          
          echo "Moving Android binaries to unified build directory"
          mkdir -p ${{ env.BUILD_DIR }}
          # The official build places binaries in native/out/<ABI>/magiskboot
          mv native/out/arm64/magiskboot ${{ env.BUILD_DIR }}/magiskboot-arm64
          mv native/out/arm/magiskboot ${{ env.BUILD_DIR }}/magiskboot-arm32
          mv native/out/x64/magiskboot ${{ env.BUILD_DIR }}/magiskboot-x64
          mv native/out/x86/magiskboot ${{ env.BUILD_DIR }}/magiskboot-x86

      - name: üèóÔ∏è Compile magiskboot for Linux/Windows Targets
        # This step uses the system compiler and installed libraries for non-NDK targets.
        # It links the required compression libraries found in the search results.
        run: |
          MAGISK_NATIVE_SRC=$(pwd)/native/magiskboot
          BUILD_DIR=${{ env.BUILD_DIR }}
          
          # Common compiler flags for C++ and linking required libraries
          # We need to compile the C and Rust source files and link against compression libs
          CXX_FLAGS="-std=c++17 -Wl,-Bstatic -llzma -llz4 -lbz2 -lz -Wl,-Bdynamic"
          
          echo "Building Linux Targets..."
          # Linux 64-bit (using host GCC/G++)
          g++ $MAGISK_NATIVE_SRC/*.c $MAGISK_NATIVE_SRC/*.cpp $CXX_FLAGS -o $BUILD_DIR/magiskboot-linux64
          # Linux 32-bit (using multilib GCC/G++)
          g++ -m32 $MAGISK_NATIVE_SRC/*.c $MAGISK_NATIVE_SRC/*.cpp $CXX_FLAGS -o $BUILD_DIR/magiskboot-linux32

          echo "Building Windows Targets (Mingw-w64)..."
          # Windows 64-bit
          x86_64-w64-mingw32-g++ $MAGISK_NATIVE_SRC/*.c $MAGISK_NATIVE_SRC/*.cpp $CXX_FLAGS -o $BUILD_DIR/magiskboot-win64.exe
          # Windows 32-bit
          i686-w64-mingw32-g++ $MAGISK_NATIVE_SRC/*.c $MAGISK_NATIVE_SRC/*.cpp $CXX_FLAGS -o $BUILD_DIR/magiskboot-win32.exe
          
      - name: üìä Calculate SHA256 Checksums
        run: |
          cd ${{ env.BUILD_DIR }}
          echo "Generating SHA256 checksums..."
          for file in *; do
            if [ -f "$file" ]; then
              # The sha256sum command is the same on the Linux runner
              sha256sum "$file" >> ../../SHA256SUMS.txt
            fi
          done
          mv ../../SHA256SUMS.txt ${{ github.workspace }}
      
      - name: üì¶ Archive Build Artifacts and Create Release
        run: zip -j release-artifacts.zip ${{ env.BUILD_DIR }}/* SHA256SUMS.txt
      
      - name: üìù Set Release Tag and Title
        id: set_tag
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          # Use the commit SHA if the input branch is a commit, or the branch/tag name
          SOURCE_IDENTIFIER=$(echo "${{ env.MAGISK_BRANCH }}" | cut -c1-8)
          RELEASE_TAG="magiskboot-build-${SOURCE_IDENTIFIER}-${TIMESTAMP}"
          RELEASE_TITLE="Magiskboot Universal Build (${{ env.MAGISK_BRANCH }})"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_title=$RELEASE_TITLE" >> $GITHUB_OUTPUT

      - name: üì§ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.set_tag.outputs.release_tag }}
          name: ${{ steps.set_tag.outputs.release_title }}
          body: |
            ## Magiskboot Universal Binary Build
            
            This is an automated cross-compilation of the `magiskboot` utility from the Magisk source code.

            **Source Branch/Tag/Commit:** `${{ env.MAGISK_BRANCH }}`
            
            ### Included Binaries (SHA256SUMS.txt inside zip)
            
            * **Android Targets:** `magiskboot-arm64`, `magiskboot-arm32`, `magiskboot-x64`, `magiskboot-x86`
            * **Linux Targets:** `magiskboot-linux64`, `magiskboot-linux32`
            * **Windows Targets:** `magiskboot-win64.exe`, `magiskboot-win32.exe`
            
            **Disclaimer:** The official Magisk repo primarily supports Android via NDK. Linux/Windows binaries are compiled via best-effort cross-compilation and are not officially supported by Magisk upstream.
          files: release-artifacts.zip
